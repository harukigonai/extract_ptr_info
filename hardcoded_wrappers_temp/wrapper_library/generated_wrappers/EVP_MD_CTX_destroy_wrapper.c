#define _GNU_SOURCE

#include <stdio.h>
#include <dlfcn.h>
#include <sys/syscall.h>
#include <unistd.h>
#include <openssl/crypto.h>
#include <openssl/err.h>
#include <openssl/x509.h>
#include <openssl/x509v3.h>
#include <openssl/pem.h>
#include <openssl/pkcs12.h>
#include <openssl/ui.h>
#include <openssl/safestack.h>
#include <openssl/ssl.h>
#include <openssl/e_os2.h>
#include <openssl/crypto.h>
#include <openssl/err.h>
#include <openssl/ssl.h>
#include <openssl/evp.h>
#include <openssl/bn.h>
#include <openssl/x509v3.h>
#include <openssl/ocsp.h>
#include <openssl/srp.h>

#include "../arg_struct.h"

void bb_EVP_MD_CTX_destroy(EVP_MD_CTX * arg_a);

void EVP_MD_CTX_destroy(EVP_MD_CTX * arg_a) 
{
    unsigned long in_lib = syscall(890);
    printf("EVP_MD_CTX_destroy called %lu\n", in_lib);
    if (!in_lib)
        bb_EVP_MD_CTX_destroy(arg_a);
    else {
        void (*orig_EVP_MD_CTX_destroy)(EVP_MD_CTX *);
        orig_EVP_MD_CTX_destroy = dlsym(RTLD_NEXT, "EVP_MD_CTX_destroy");
        orig_EVP_MD_CTX_destroy(arg_a);
    }
}

void bb_EVP_MD_CTX_destroy(EVP_MD_CTX * arg_a) 
{
    struct lib_enter_args args = {
        .num_args = 0,
        .entity_metadata = {
            1, 8, 1, /* 0: pointer.int */
            	5, 0,
            0, 4, 0, /* 5: int */
            0, 8, 1, /* 8: struct.fnames */
            	13, 0,
            1, 8, 1, /* 13: pointer.char */
            	4096, 0,
            4097, 94396196030000, 0, /* 18: pointer.func */
            4097, 94416508954113, 94396198323280, /* 21: pointer.func */
            	0, 0,
            	0, 4097,
            	0, 65,
            	0, 0,
            	0, 4097,
            	94396198369408, 94396198363088,
            	4097, 32,
            	94416508951905, 4097,
            	192, 32,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 94396198140240,
            	0, 0,
            	0, 0,
            	0, 56,
            	4, 71,
            	16, 93,
            	24, 8,
            	32, 220,
            	48, 1,
            	8, 1,
            	76, 0,
            	0, 208,
            	3, 13,
            	16, 13,
            	24, 85,
            	32, 1,
            	8, 1,
            	90, 0,
            	0, 0,
            	0, 1,
            	8, 1,
            	98, 0,
            	0, 216,
            	13, 13,
            	0, 13,
            	8, 127,
            	16, 139,
            	24, 151,
            	32, 163,
            	40, 175,
            	48, 187,
            	56, 195,
            	64, 203,
            	160, 215,
            	184, 93,
            	200, 93,
            	208, 1,
            	8, 1,
            	132, 0,
            	0, 112,
            	2, 13,
            	0, 13,
            	80, 1,
            	8, 1,
            	144, 0,
            	0, 96,
            	2, 13,
            	0, 13,
            	72, 1,
            	8, 1,
            	156, 0,
            	0, 72,
            	2, 13,
            	0, 13,
            	56, 1,
            	8, 1,
            	168, 0,
            	0, 32,
            	2, 13,
            	0, 13,
            	24, 1,
            	8, 1,
            	180, 0,
            	0, 48,
            	2, 13,
            	0, 13,
            	40, 1,
            	8, 1,
            	192, 0,
            	0, 48,
            	0, 1,
            	8, 1,
            	200, 0,
            	0, 0,
            	0, 1,
            	8, 1,
            	208, 0,
            	0, 32,
            	2, 13,
            	8, 13,
            	16, 0,
            	16, 1,
            	220, 0,
            	1, 8,
            	1, 225,
            	0, 0,
            	32, 1,
            	230, 0,
            	0, 32,
            	1, 235,
            	8, 1,
            	8, 1,
            	13, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 94396197187248,
            	0, 0,
            	0, 0,
            	4097, 0,
            	94396198364880, 0,
            	0, 0,
            	4097, 94396198361936,
            	64, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	94396198362800, 94396198362448,
            	4097, 32,
            	94416508953314, 0,
            	0, 0,
            	4097, 94396198369568,
            	0, 4097,
            	94396198364240, 94396198370528,
            	0, 0,
            	0, 4097,
            	1, 33,
            	0, 0,
            	0, 4097,
            	94416508953250, 94396197356496,
            	4097, 289,
            	94396198364528, 4097,
            	0, 129,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 65,
            	94396198362512, 0,
            	0, 0,
            	1, 8,
            	1, 323,
            	0, 0,
            	48, 4,
            	334, 0,
            	93, 8,
            	13, 24,
            	342, 32,
            	1, 8,
            	1, 339,
            	0, 0,
            	120, 0,
            	1, 8,
            	1, 347,
            	0, 0,
            	80, 8,
            	366, 0,
            	93, 8,
            	392, 16,
            	392, 24,
            	13, 40,
            	13, 48,
            	85, 56,
            	0, 64,
            	1, 8,
            	1, 371,
            	0, 0,
            	208, 9,
            	85, 8,
            	85, 32,
            	85, 48,
            	85, 64,
            	85, 80,
            	85, 96,
            	85, 144,
            	85, 160,
            	85, 176,
            	1, 8,
            	1, 60,
            	0, 4097,
            	94416508945362, 94396198173696,
            	4097, 65,
            	94396198364144, 4097,
            	0, 33,
            	4097, 140425329646816,
            	192, 0,
            	0, 0,
            	4097, 65,
            	94396198366432, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	94416508951010, 94396197796480,
            	0, 0,
            	0, 4097,
            	32, 32,
            	4097, 94396197775840,
            	64, 0,
            	0, 0,
            	4097, 353,
            	94396198369968, 4097,
            	0, 97,
            	4097, 140425329646816,
            	0, 0,
            	0, 0,
            	4097, 33,
            	94396198366192, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	94396198363184, 94396198366352,
            	4097, 65,
            	94396198362832, 4097,
            	0, 33,
            	0, 0,
            	0, 4097,
            	94416508953410, 94396196568048,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 94396196605200,
            	3712, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 65,
            	4097, 94396198364400,
            	0, 0,
            	0, 0,
            	4097, 48,
            	94416508953922, 4097,
            	94396198360176, 94396198361280,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	94396198370656, 94396198369776,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 48,
            	94416508957394, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	8, 0,
            	4097, 94396198369536,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	94416508959698, 94396198357872,
            	4097, 0,
            	94396196588688, 4097,
            	94396198369408, 94396198370688,
            	4097, 48,
            	94416508953826, 0,
            	1, 0,
            	0, 20,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 94396198370528,
            	0, 0,
            	0, 0,
            	4097, 32,
            	94416508951458, 4097,
            	4592, 48,
            	0, 0,
            	0, 4097,
            	94396197467952, 2225,
            	4097, 94396198369168,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
        },
        .arg_entity_index = { 318, },
        .ret_entity_index = -1,
    };
    struct lib_enter_args *args_addr = &args;
    populate_arg(args_addr, arg_a);

    struct lib_enter_args *new_args = (struct lib_enter_args *)syscall(888, args_addr);

    EVP_MD_CTX * new_arg_a = *((EVP_MD_CTX * *)new_args->args[0]);

    void (*orig_EVP_MD_CTX_destroy)(EVP_MD_CTX *);
    orig_EVP_MD_CTX_destroy = dlsym(RTLD_NEXT, "EVP_MD_CTX_destroy");
    (*orig_EVP_MD_CTX_destroy)(new_arg_a);

    syscall(889);

}

