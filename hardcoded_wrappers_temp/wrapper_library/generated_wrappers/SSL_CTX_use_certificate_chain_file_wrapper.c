#define _GNU_SOURCE

#include <stdio.h>
#include <dlfcn.h>
#include <sys/syscall.h>
#include <unistd.h>
#include <openssl/crypto.h>
#include <openssl/err.h>
#include <openssl/x509.h>
#include <openssl/x509v3.h>
#include <openssl/pem.h>
#include <openssl/pkcs12.h>
#include <openssl/ui.h>
#include <openssl/safestack.h>
#include <openssl/ssl.h>
#include <openssl/e_os2.h>
#include <openssl/crypto.h>
#include <openssl/err.h>
#include <openssl/ssl.h>
#include <openssl/evp.h>
#include <openssl/bn.h>
#include <openssl/x509v3.h>
#include <openssl/ocsp.h>
#include <openssl/srp.h>

#include "../arg_struct.h"

int bb_SSL_CTX_use_certificate_chain_file(SSL_CTX * arg_a,const char * arg_b);

int SSL_CTX_use_certificate_chain_file(SSL_CTX * arg_a,const char * arg_b) 
{
    unsigned long in_lib = syscall(890);
    printf("SSL_CTX_use_certificate_chain_file called %lu\n", in_lib);
    if (!in_lib)
        return bb_SSL_CTX_use_certificate_chain_file(arg_a,arg_b);
    else {
        int (*orig_SSL_CTX_use_certificate_chain_file)(SSL_CTX *,const char *);
        orig_SSL_CTX_use_certificate_chain_file = dlsym(RTLD_NEXT, "SSL_CTX_use_certificate_chain_file");
        return orig_SSL_CTX_use_certificate_chain_file(arg_a,arg_b);
    }
}

int bb_SSL_CTX_use_certificate_chain_file(SSL_CTX * arg_a,const char * arg_b) 
{
    int ret;

    struct lib_enter_args args = {
        .num_args = 0,
        .entity_metadata = {
            0, 0, 0, /* 0: func */
            0, 0, 0, /* 3: func */
            0, 8, 1, /* 6: struct.ssl3_buf_freelist_entry_st */
            	11, 0,
            1, 8, 1, /* 11: pointer.struct.ssl3_buf_freelist_entry_st */
            	6, 0,
            0, 0, 0, /* 16: func */
            4097, 94417161610169, 94396549060832, /* 19: pointer.func */
            	0, 16,
            	0, 0,
            	0, 0,
            	4097, 62241,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 1,
            	8, 1,
            	42, 0,
            	0, 296,
            	5, 55,
            	0, 505,
            	48, 604,
            	64, 636,
            	80, 718,
            	96, 1,
            	8, 1,
            	60, 0,
            	0, 24,
            	3, 69,
            	0, 257,
            	8, 497,
            	16, 1,
            	8, 1,
            	74, 0,
            	0, 184,
            	12, 101,
            	0, 146,
            	8, 131,
            	16, 141,
            	32, 417,
            	40, 131,
            	104, 427,
            	112, 441,
            	120, 201,
            	128, 201,
            	136, 467,
            	144, 479,
            	176, 1,
            	8, 1,
            	106, 0,
            	0, 104,
            	11, 131,
            	0, 131,
            	8, 146,
            	16, 187,
            	24, 231,
            	32, 187,
            	40, 243,
            	48, 131,
            	56, 131,
            	64, 201,
            	72, 422,
            	80, 1,
            	8, 1,
            	136, 0,
            	0, 24,
            	1, 141,
            	8, 1,
            	8, 1,
            	4096, 0,
            	1, 8,
            	1, 151,
            	0, 0,
            	16, 2,
            	158, 0,
            	172, 8,
            	1, 8,
            	1, 163,
            	0, 0,
            	40, 3,
            	141, 0,
            	141, 8,
            	141, 24,
            	1, 8,
            	1, 177,
            	0, 0,
            	16, 1,
            	182, 8,
            	0, 8,
            	1, 141,
            	0, 1,
            	8, 1,
            	192, 0,
            	0, 40,
            	3, 201,
            	0, 221,
            	16, 141,
            	24, 1,
            	8, 1,
            	206, 0,
            	0, 32,
            	1, 211,
            	0, 0,
            	32, 1,
            	216, 8,
            	1, 8,
            	1, 141,
            	0, 1,
            	8, 1,
            	226, 0,
            	0, 24,
            	1, 141,
            	8, 1,
            	8, 1,
            	236, 0,
            	0, 16,
            	2, 131,
            	0, 131,
            	8, 1,
            	8, 1,
            	248, 0,
            	0, 24,
            	3, 146,
            	0, 131,
            	8, 257,
            	16, 1,
            	8, 1,
            	262, 0,
            	0, 56,
            	4, 273,
            	16, 295,
            	24, 182,
            	32, 201,
            	48, 1,
            	8, 1,
            	278, 0,
            	0, 208,
            	3, 141,
            	16, 141,
            	24, 287,
            	32, 1,
            	8, 1,
            	292, 0,
            	0, 0,
            	0, 1,
            	8, 1,
            	300, 0,
            	0, 216,
            	13, 141,
            	0, 141,
            	8, 329,
            	16, 341,
            	24, 353,
            	32, 365,
            	40, 377,
            	48, 389,
            	56, 397,
            	64, 405,
            	160, 417,
            	184, 295,
            	200, 295,
            	208, 1,
            	8, 1,
            	334, 0,
            	0, 112,
            	2, 141,
            	0, 141,
            	80, 1,
            	8, 1,
            	346, 0,
            	0, 96,
            	2, 141,
            	0, 141,
            	72, 1,
            	8, 1,
            	358, 0,
            	0, 72,
            	2, 141,
            	0, 141,
            	56, 1,
            	8, 1,
            	370, 0,
            	0, 32,
            	2, 141,
            	0, 141,
            	24, 1,
            	8, 1,
            	382, 0,
            	0, 48,
            	2, 141,
            	0, 141,
            	40, 1,
            	8, 1,
            	394, 0,
            	0, 48,
            	0, 1,
            	8, 1,
            	402, 0,
            	0, 0,
            	0, 1,
            	8, 1,
            	410, 0,
            	0, 32,
            	2, 141,
            	8, 141,
            	16, 0,
            	16, 1,
            	201, 0,
            	0, 24,
            	1, 141,
            	0, 1,
            	8, 1,
            	432, 0,
            	0, 24,
            	3, 131,
            	0, 201,
            	8, 131,
            	16, 1,
            	8, 1,
            	446, 0,
            	0, 40,
            	2, 453,
            	0, 201,
            	8, 1,
            	8, 1,
            	458, 0,
            	0, 32,
            	3, 158,
            	8, 201,
            	16, 201,
            	24, 1,
            	8, 1,
            	472, 0,
            	0, 16,
            	2, 201,
            	0, 201,
            	8, 1,
            	8, 1,
            	484, 0,
            	0, 40,
            	5, 201,
            	0, 201,
            	8, 131,
            	16, 131,
            	24, 201,
            	32, 1,
            	8, 1,
            	502, 0,
            	0, 120,
            	0, 1,
            	8, 1,
            	510, 0,
            	0, 168,
            	17, 329,
            	16, 295,
            	24, 547,
            	32, 547,
            	40, 547,
            	48, 547,
            	56, 547,
            	64, 547,
            	72, 547,
            	80, 547,
            	88, 417,
            	96, 565,
            	120, 565,
            	128, 565,
            	136, 141,
            	144, 579,
            	152, 579,
            	160, 1,
            	8, 1,
            	552, 0,
            	0, 24,
            	1, 557,
            	0, 1,
            	8, 1,
            	562, 0,
            	0, 4,
            	0, 1,
            	8, 1,
            	570, 0,
            	0, 96,
            	3, 552,
            	8, 552,
            	32, 552,
            	56, 1,
            	8, 1,
            	584, 0,
            	0, 88,
            	6, 547,
            	0, 547,
            	8, 547,
            	16, 547,
            	24, 599,
            	40, 565,
            	72, 0,
            	16, 1,
            	141, 0,
            	1, 8,
            	1, 609,
            	0, 0,
            	144, 12,
            	547, 8,
            	547, 16,
            	547, 32,
            	547, 40,
            	565, 56,
            	547, 64,
            	547, 72,
            	141, 80,
            	547, 96,
            	417, 112,
            	353, 128,
            	295, 136,
            	1, 8,
            	1, 641,
            	0, 0,
            	56, 4,
            	652, 8,
            	690, 16,
            	547, 24,
            	706, 48,
            	1, 8,
            	1, 657,
            	0, 0,
            	232, 11,
            	682, 0,
            	690, 8,
            	552, 16,
            	552, 40,
            	141, 80,
            	706, 96,
            	552, 104,
            	552, 152,
            	552, 176,
            	141, 208,
            	141, 216,
            	1, 8,
            	1, 687,
            	0, 0,
            	304, 0,
            	1, 8,
            	1, 695,
            	0, 0,
            	88, 4,
            	682, 0,
            	552, 8,
            	552, 32,
            	552, 56,
            	1, 8,
            	1, 711,
            	0, 0,
            	40, 2,
            	706, 0,
            	141, 8,
            	0, 192,
            	8, 60,
            	0, 60,
            	24, 60,
            	48, 60,
            	72, 60,
            	96, 60,
            	120, 60,
            	144, 60,
            	168, 0,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 44,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 88,
            	1, 141,
            	8, 1,
            	8, 1,
            	770, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	24, 1,
            	11, 16,
            	4097, 0,
            	0, 0,
            	8, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 20,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 32,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 24,
            	0, 4097,
            	0, 0,
            	0, 248,
            	6, 201,
            	0, 55,
            	16, 718,
            	24, 505,
            	216, 604,
            	224, 636,
            	232, 0,
            	232, 1,
            	982, 200,
            	1, 8,
            	1, 987,
            	0, 0,
            	112, 2,
            	141, 64,
            	141, 80,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 48,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	1, 0,
            	0, 4,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	352, 14,
            	141, 144,
            	141, 152,
            	1076, 168,
            	69, 176,
            	775, 224,
            	201, 240,
            	417, 248,
            	1081, 264,
            	1081, 272,
            	141, 280,
            	141, 296,
            	141, 312,
            	141, 320,
            	141, 344,
            	1, 8,
            	1, 962,
            	0, 1,
            	8, 1,
            	1045, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 144,
            	4, 201,
            	8, 201,
            	16, 1109,
            	24, 417,
            	120, 1,
            	8, 1,
            	1114, 0,
            	0, 56,
            	2, 141,
            	0, 201,
            	48, 1,
            	8, 1,
            	1098, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 1,
            	8, 1,
            	1018, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 8,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	1, 8,
            	1, 1235,
            	0, 0,
            	736, 30,
            	1298, 0,
            	201, 8,
            	201, 16,
            	1121, 24,
            	1159, 32,
            	1081, 48,
            	1081, 56,
            	141, 160,
            	141, 176,
            	417, 208,
            	497, 224,
            	497, 232,
            	497, 240,
            	201, 248,
            	201, 256,
            	201, 272,
            	37, 304,
            	141, 328,
            	1109, 392,
            	295, 408,
            	141, 424,
            	141, 496,
            	141, 512,
            	141, 520,
            	1303, 552,
            	1303, 560,
            	1308, 568,
            	141, 704,
            	141, 720,
            	201, 728,
            	1, 8,
            	1, 977,
            	0, 1,
            	8, 1,
            	873, 0,
            	0, 128,
            	11, 141,
            	0, 141,
            	32, 547,
            	40, 547,
            	48, 547,
            	56, 547,
            	64, 547,
            	72, 547,
            	80, 547,
            	88, 547,
            	96, 141,
            	104, 0,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 8,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 0,
            	20, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
        },
        .arg_entity_index = { 1230, 141, },
        .ret_entity_index = 562,
    };
    struct lib_enter_args *args_addr = &args;
    populate_arg(args_addr, arg_a);
    populate_arg(args_addr, arg_b);
    populate_ret(args_addr, ret);

    struct lib_enter_args *new_args = (struct lib_enter_args *)syscall(888, args_addr);

    SSL_CTX * new_arg_a = *((SSL_CTX * *)new_args->args[0]);

    const char * new_arg_b = *((const char * *)new_args->args[1]);

    int *new_ret_ptr = (int *)new_args->ret;

    int (*orig_SSL_CTX_use_certificate_chain_file)(SSL_CTX *,const char *);
    orig_SSL_CTX_use_certificate_chain_file = dlsym(RTLD_NEXT, "SSL_CTX_use_certificate_chain_file");
    *new_ret_ptr = (*orig_SSL_CTX_use_certificate_chain_file)(new_arg_a,new_arg_b);

    syscall(889);

    return ret;
}

