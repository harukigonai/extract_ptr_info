#define _GNU_SOURCE

#include <stdio.h>
#include <dlfcn.h>
#include <sys/syscall.h>
#include <unistd.h>
#include <openssl/crypto.h>
#include <openssl/err.h>
#include <openssl/x509.h>
#include <openssl/x509v3.h>
#include <openssl/pem.h>
#include <openssl/pkcs12.h>
#include <openssl/ui.h>
#include <openssl/safestack.h>
#include <openssl/ssl.h>
#include <openssl/e_os2.h>
#include <openssl/crypto.h>
#include <openssl/err.h>
#include <openssl/ssl.h>
#include <openssl/evp.h>
#include <openssl/bn.h>
#include <openssl/x509v3.h>
#include <openssl/ocsp.h>
#include <openssl/srp.h>

#include "../arg_struct.h"

int bb_HMAC_Init_ex(HMAC_CTX * arg_a,const void * arg_b,int arg_c,const EVP_MD * arg_d,ENGINE * arg_e);

int HMAC_Init_ex(HMAC_CTX * arg_a,const void * arg_b,int arg_c,const EVP_MD * arg_d,ENGINE * arg_e) 
{
    unsigned long in_lib = syscall(890);
    printf("HMAC_Init_ex called %lu\n", in_lib);
    if (!in_lib)
        return bb_HMAC_Init_ex(arg_a,arg_b,arg_c,arg_d,arg_e);
    else {
        int (*orig_HMAC_Init_ex)(HMAC_CTX *,const void *,int,const EVP_MD *,ENGINE *);
        orig_HMAC_Init_ex = dlsym(RTLD_NEXT, "HMAC_Init_ex");
        return orig_HMAC_Init_ex(arg_a,arg_b,arg_c,arg_d,arg_e);
    }
}

int bb_HMAC_Init_ex(HMAC_CTX * arg_a,const void * arg_b,int arg_c,const EVP_MD * arg_d,ENGINE * arg_e) 
{
    int ret;

    struct lib_enter_args args = {
        .num_args = 0,
        .entity_metadata = {
            1, 8, 1, /* 0: pointer.int */
            	5, 0,
            0, 4, 0, /* 5: int */
            0, 8, 1, /* 8: struct.fnames */
            	13, 0,
            1, 8, 1, /* 13: pointer.char */
            	4096, 0,
            4097, 94396186434864, 94396186435056, /* 18: pointer.func */
            	4097, 94396185319600,
            	337, 0,
            	0, 0,
            	0, 128,
            	0, 4097,
            	94396186436720, 94396186443792,
            	0, 0,
            	0, 4097,
            	94396186431792, 94396186435824,
            	4097, 144,
            	48, 4097,
            	94396186433760, 94396186433232,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 288,
            	48, 0,
            	0, 0,
            	0, 56,
            	4, 74,
            	16, 96,
            	24, 8,
            	32, 223,
            	48, 1,
            	8, 1,
            	79, 0,
            	0, 208,
            	3, 13,
            	16, 13,
            	24, 88,
            	32, 1,
            	8, 1,
            	93, 0,
            	0, 0,
            	0, 1,
            	8, 1,
            	101, 0,
            	0, 216,
            	13, 13,
            	0, 13,
            	8, 130,
            	16, 142,
            	24, 154,
            	32, 166,
            	40, 178,
            	48, 190,
            	56, 198,
            	64, 206,
            	160, 218,
            	184, 96,
            	200, 96,
            	208, 1,
            	8, 1,
            	135, 0,
            	0, 112,
            	2, 13,
            	0, 13,
            	80, 1,
            	8, 1,
            	147, 0,
            	0, 96,
            	2, 13,
            	0, 13,
            	72, 1,
            	8, 1,
            	159, 0,
            	0, 72,
            	2, 13,
            	0, 13,
            	56, 1,
            	8, 1,
            	171, 0,
            	0, 32,
            	2, 13,
            	0, 13,
            	24, 1,
            	8, 1,
            	183, 0,
            	0, 48,
            	2, 13,
            	0, 13,
            	40, 1,
            	8, 1,
            	195, 0,
            	0, 48,
            	0, 1,
            	8, 1,
            	203, 0,
            	0, 0,
            	0, 1,
            	8, 1,
            	211, 0,
            	0, 32,
            	2, 13,
            	8, 13,
            	16, 0,
            	16, 1,
            	223, 0,
            	1, 8,
            	1, 228,
            	0, 0,
            	32, 1,
            	233, 0,
            	0, 32,
            	1, 238,
            	8, 1,
            	8, 1,
            	13, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	94396186441072, 0,
            	0, 0,
            	0, 4097,
            	32, 94416510125282,
            	0, 0,
            	0, 4097,
            	94396186443920, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 94416510132002,
            	94396184272224, 4097,
            	481, 94396186439216,
            	0, 0,
            	0, 4097,
            	94396186447392, 32,
            	4097, 94416510124290,
            	94396184334288, 0,
            	0, 0,
            	4097, 128,
            	32, 0,
            	0, 0,
            	4097, 94416510131810,
            	94396184235072, 4097,
            	97, 94396186438160,
            	4097, 32,
            	32, 0,
            	0, 0,
            	4097, 94396186445952,
            	94396186444144, 4097,
            	32, 94416510131042,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 94416510130658,
            	94396184470512, 4097,
            	97, 94396186443920,
            	4097, 32,
            	32, 4097,
            	94396184516064, 64,
            	4097, 94416510125090,
            	94396184396208, 0,
            	0, 0,
            	4097, 832,
            	32, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	32, 94416510131394,
            	0, 0,
            	0, 4097,
            	94396186439280, 1664,
            	0, 0,
            	0, 4097,
            	1825, 94396186445472,
            	0, 0,
            	0, 4097,
            	94396184660688, 0,
            	4097, 94396186438800,
            	94396186438928, 4097,
            	32, 94416510126018,
            	0, 288,
            	4, 392,
            	0, 400,
            	8, 400,
            	56, 400,
            	104, 1,
            	8, 1,
            	397, 0,
            	0, 120,
            	0, 0,
            	48, 4,
            	392, 0,
            	96, 8,
            	13, 24,
            	411, 32,
            	1, 8,
            	1, 416,
            	0, 0,
            	80, 8,
            	435, 0,
            	96, 8,
            	461, 16,
            	461, 24,
            	13, 40,
            	13, 48,
            	88, 56,
            	0, 64,
            	1, 8,
            	1, 440,
            	0, 0,
            	208, 9,
            	88, 8,
            	88, 32,
            	88, 48,
            	88, 64,
            	88, 80,
            	88, 96,
            	88, 144,
            	88, 160,
            	88, 176,
            	1, 8,
            	1, 63,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	140425329646816, 1,
            	4097, 94396186445632,
            	94396186444240, 4097,
            	65, 94396186445632,
            	0, 0,
            	0, 4097,
            	140425329646816, 160,
            	0, 0,
            	0, 0,
            	8, 0,
            	4097, 32,
            	32, 4097,
            	94396185086288, 1,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 1088,
            	32, 4097,
            	94396185419456, 0,
            	0, 0,
            	0, 4097,
            	32, 94416510130883,
            	4097, 64,
            	32, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	97, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	33, 94396186446672,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	33, 4097,
            	94396186446672, 96,
            	4097, 94416510130179,
            	94396185294832, 4097,
            	97, 94396186439280,
            	0, 1,
            	0, 0,
            	20, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	94396186443920, 3520,
            	0, 0,
            	0, 4097,
            	481, 94396186445312,
            	4097, 0,
            	65, 0,
            	0, 0,
            	4097, 94396186437680,
            	140425329646816, 4097,
            	32, 94416510124323,
            	0, 0,
            	0, 4097,
            	94396186440688, 32,
            	4097, 94416510124387,
            	94396185769200, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	94396186445952, 32,
            	4097, 94416509720691,
            	94396185340240, 4097,
            	97, 94396186439440,
            	0, 0,
            	0, 4097,
            	94396186440976, 0,
            	0, 0,
            	0, 4097,
            	32, 94416510124963,
            	0, 0,
            	0, 4097,
            	94396184098848, 0,
            	4097, 94396186441648,
            	94396186446672, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	94396186446672, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 1,
            	8, 1,
            	381, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
        },
        .arg_entity_index = { 676, 13, 5, 392, 96, },
        .ret_entity_index = 5,
    };
    struct lib_enter_args *args_addr = &args;
    populate_arg(args_addr, arg_a);
    populate_arg(args_addr, arg_b);
    populate_arg(args_addr, arg_c);
    populate_arg(args_addr, arg_d);
    populate_arg(args_addr, arg_e);
    populate_ret(args_addr, ret);

    struct lib_enter_args *new_args = (struct lib_enter_args *)syscall(888, args_addr);

    HMAC_CTX * new_arg_a = *((HMAC_CTX * *)new_args->args[0]);

    const void * new_arg_b = *((const void * *)new_args->args[1]);

    int new_arg_c = *((int *)new_args->args[2]);

    const EVP_MD * new_arg_d = *((const EVP_MD * *)new_args->args[3]);

    ENGINE * new_arg_e = *((ENGINE * *)new_args->args[4]);

    int *new_ret_ptr = (int *)new_args->ret;

    int (*orig_HMAC_Init_ex)(HMAC_CTX *,const void *,int,const EVP_MD *,ENGINE *);
    orig_HMAC_Init_ex = dlsym(RTLD_NEXT, "HMAC_Init_ex");
    *new_ret_ptr = (*orig_HMAC_Init_ex)(new_arg_a,new_arg_b,new_arg_c,new_arg_d,new_arg_e);

    syscall(889);

    return ret;
}

