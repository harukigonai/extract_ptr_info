#define _GNU_SOURCE

#include <stdio.h>
#include <dlfcn.h>
#include <sys/syscall.h>
#include <unistd.h>
#include <openssl/crypto.h>
#include <openssl/err.h>
#include <openssl/x509.h>
#include <openssl/x509v3.h>
#include <openssl/pem.h>
#include <openssl/pkcs12.h>
#include <openssl/ui.h>
#include <openssl/safestack.h>
#include <openssl/ssl.h>
#include <openssl/e_os2.h>
#include <openssl/crypto.h>
#include <openssl/err.h>
#include <openssl/ssl.h>
#include <openssl/evp.h>
#include <openssl/bn.h>
#include <openssl/x509v3.h>
#include <openssl/ocsp.h>
#include <openssl/srp.h>

#include "../arg_struct.h"

X509_STORE_CTX * bb_X509_STORE_CTX_new(void);

X509_STORE_CTX * X509_STORE_CTX_new(void) 
{
    unsigned long in_lib = syscall(890);
    printf("X509_STORE_CTX_new called %lu\n", in_lib);
    if (!in_lib)
        return bb_X509_STORE_CTX_new();
    else {
        X509_STORE_CTX * (*orig_X509_STORE_CTX_new)(void);
        orig_X509_STORE_CTX_new = dlsym(RTLD_NEXT, "X509_STORE_CTX_new");
        return orig_X509_STORE_CTX_new();
    }
}

X509_STORE_CTX * bb_X509_STORE_CTX_new(void) 
{
    X509_STORE_CTX * ret;

    struct lib_enter_args args = {
        .num_args = 0,
        .entity_metadata = {
            4097, 94396211655936, 94396211646592, /* 0: pointer.func */
            	4097, 94396210132224,
            	130017, 0,
            	0, 0,
            	0, 24,
            	2, 16,
            	8, 46,
            	16, 0,
            	8, 1,
            	21, 0,
            	1, 8,
            	1, 26,
            	0, 0,
            	32, 1,
            	31, 0,
            	0, 32,
            	1, 36,
            	8, 1,
            	8, 1,
            	41, 0,
            	1, 8,
            	1, 4096,
            	0, 1,
            	8, 1,
            	51, 0,
            	0, 40,
            	3, 21,
            	0, 60,
            	16, 41,
            	24, 1,
            	8, 1,
            	65, 0,
            	0, 24,
            	1, 41,
            	8, 1,
            	8, 1,
            	75, 0,
            	0, 32,
            	2, 82,
            	0, 87,
            	16, 1,
            	8, 1,
            	9, 0,
            	1, 8,
            	1, 92,
            	0, 0,
            	24, 1,
            	41, 8,
            	0, 80,
            	8, 87,
            	0, 116,
            	8, 46,
            	16, 87,
            	24, 87,
            	32, 21,
            	40, 21,
            	48, 157,
            	56, 1,
            	8, 1,
            	121, 0,
            	0, 16,
            	2, 128,
            	0, 142,
            	8, 1,
            	8, 1,
            	133, 0,
            	0, 40,
            	3, 41,
            	0, 41,
            	8, 41,
            	24, 1,
            	8, 1,
            	147, 0,
            	0, 16,
            	1, 152,
            	8, 0,
            	8, 1,
            	41, 0,
            	0, 24,
            	1, 41,
            	0, 1,
            	8, 1,
            	97, 0,
            	1, 8,
            	1, 172,
            	0, 0,
            	24, 2,
            	179, 0,
            	167, 8,
            	1, 8,
            	1, 184,
            	0, 0,
            	32, 3,
            	128, 8,
            	21, 16,
            	21, 24,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	1, 8,
            	1, 228,
            	0, 0,
            	40, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 56,
            	4, 248,
            	16, 270,
            	24, 152,
            	32, 21,
            	48, 1,
            	8, 1,
            	253, 0,
            	0, 208,
            	3, 41,
            	16, 41,
            	24, 262,
            	32, 1,
            	8, 1,
            	267, 0,
            	0, 0,
            	0, 1,
            	8, 1,
            	275, 0,
            	0, 216,
            	13, 41,
            	0, 41,
            	8, 304,
            	16, 316,
            	24, 328,
            	32, 340,
            	40, 352,
            	48, 364,
            	56, 372,
            	64, 380,
            	160, 392,
            	184, 270,
            	200, 270,
            	208, 1,
            	8, 1,
            	309, 0,
            	0, 112,
            	2, 41,
            	0, 41,
            	80, 1,
            	8, 1,
            	321, 0,
            	0, 96,
            	2, 41,
            	0, 41,
            	72, 1,
            	8, 1,
            	333, 0,
            	0, 72,
            	2, 41,
            	0, 41,
            	56, 1,
            	8, 1,
            	345, 0,
            	0, 32,
            	2, 41,
            	0, 41,
            	24, 1,
            	8, 1,
            	357, 0,
            	0, 48,
            	2, 41,
            	0, 41,
            	40, 1,
            	8, 1,
            	369, 0,
            	0, 48,
            	0, 1,
            	8, 1,
            	377, 0,
            	0, 0,
            	0, 1,
            	8, 1,
            	385, 0,
            	0, 32,
            	2, 41,
            	8, 41,
            	16, 0,
            	16, 1,
            	21, 0,
            	0, 24,
            	3, 116,
            	0, 87,
            	8, 406,
            	16, 1,
            	8, 1,
            	237, 0,
            	0, 184,
            	12, 438,
            	0, 116,
            	8, 87,
            	16, 41,
            	32, 392,
            	40, 87,
            	104, 485,
            	112, 499,
            	120, 21,
            	128, 21,
            	136, 511,
            	144, 523,
            	176, 1,
            	8, 1,
            	443, 0,
            	0, 104,
            	11, 87,
            	0, 87,
            	8, 116,
            	16, 46,
            	24, 468,
            	32, 46,
            	40, 480,
            	48, 87,
            	56, 87,
            	64, 21,
            	72, 157,
            	80, 1,
            	8, 1,
            	473, 0,
            	0, 16,
            	2, 87,
            	0, 87,
            	8, 1,
            	8, 1,
            	397, 0,
            	1, 8,
            	1, 490,
            	0, 0,
            	24, 3,
            	87, 0,
            	21, 8,
            	87, 16,
            	1, 8,
            	1, 504,
            	0, 0,
            	40, 2,
            	179, 0,
            	21, 8,
            	1, 8,
            	1, 516,
            	0, 0,
            	16, 2,
            	21, 0,
            	21, 8,
            	1, 8,
            	1, 528,
            	0, 0,
            	40, 5,
            	21, 0,
            	21, 8,
            	87, 16,
            	87, 24,
            	21, 32,
            	1, 8,
            	1, 411,
            	0, 1,
            	8, 1,
            	551, 0,
            	0, 32,
            	3, 541,
            	0, 21,
            	8, 167,
            	16, 0,
            	48, 4,
            	546, 0,
            	21, 16,
            	21, 24,
            	21, 32,
            	4097, 0,
            	0, 0,
            	20, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	1, 8,
            	1, 560,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	1, 8,
            	1, 638,
            	0, 0,
            	208, 2,
            	41, 16,
            	41, 24,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	56, 4,
            	633, 16,
            	270, 24,
            	152, 32,
            	21, 48,
            	0, 0,
            	0, 0,
            	8, 0,
            	1, 8,
            	1, 678,
            	0, 1,
            	8, 1,
            	705, 0,
            	0, 104,
            	11, 87,
            	0, 87,
            	8, 116,
            	16, 46,
            	24, 468,
            	32, 46,
            	40, 730,
            	48, 87,
            	56, 87,
            	64, 21,
            	72, 157,
            	80, 1,
            	8, 1,
            	735, 0,
            	0, 24,
            	3, 116,
            	0, 87,
            	8, 695,
            	16, 0,
            	0, 0,
            	0, 4,
            	0, 4097,
            	0, 0,
            	1, 8,
            	1, 758,
            	0, 0,
            	184, 12,
            	700, 0,
            	116, 8,
            	87, 16,
            	41, 32,
            	392, 40,
            	87, 104,
            	485, 112,
            	499, 120,
            	21, 128,
            	21, 136,
            	511, 144,
            	523, 176,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 120,
            	10, 162,
            	0, 116,
            	8, 87,
            	16, 485,
            	32, 70,
            	40, 87,
            	56, 87,
            	64, 21,
            	96, 223,
            	104, 41,
            	112, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	1, 8,
            	1, 852,
            	0, 0,
            	144, 7,
            	21, 8,
            	21, 16,
            	869, 24,
            	262, 32,
            	262, 64,
            	262, 112,
            	392, 120,
            	1, 8,
            	1, 874,
            	0, 0,
            	56, 2,
            	41, 0,
            	21, 48,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 1,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 248,
            	17, 847,
            	0, 753,
            	16, 21,
            	24, 21,
            	32, 869,
            	40, 41,
            	48, 262,
            	56, 262,
            	88, 262,
            	120, 262,
            	144, 21,
            	160, 589,
            	168, 753,
            	192, 753,
            	200, 948,
            	208, 953,
            	224, 392,
            	232, 1,
            	8, 1,
            	803, 0,
            	1, 8,
            	1, 911,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	4097, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
            	0, 0,
            	0, 4097,
            	0, 0,
            	4097, 0,
            	0, 4097,
            	0, 0,
        },
        .arg_entity_index = { -1 },
        .ret_entity_index = 953,
    };
    struct lib_enter_args *args_addr = &args;
    populate_ret(args_addr, ret);

    struct lib_enter_args *new_args = (struct lib_enter_args *)syscall(888, args_addr);

    X509_STORE_CTX * *new_ret_ptr = (X509_STORE_CTX * *)new_args->ret;

    X509_STORE_CTX * (*orig_X509_STORE_CTX_new)(void);
    orig_X509_STORE_CTX_new = dlsym(RTLD_NEXT, "X509_STORE_CTX_new");
    *new_ret_ptr = (*orig_X509_STORE_CTX_new)();

    syscall(889);

    return ret;
}

